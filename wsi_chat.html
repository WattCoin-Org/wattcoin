<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WattCoin SuperIntelligence</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 800px;
            height: 90vh;
            max-height: 700px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .header .subtitle {
            font-size: 14px;
            opacity: 0.9;
        }

        .status-bar {
            padding: 12px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #28a745;
        }

        .status-dot.offline {
            background: #dc3545;
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 16px;
            display: flex;
            flex-direction: column;
        }

        .message.user {
            align-items: flex-end;
        }

        .message.assistant {
            align-items: flex-start;
        }

        .message-bubble {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 16px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .message.user .message-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.assistant .message-bubble {
            background: white;
            border: 1px solid #e9ecef;
            border-bottom-left-radius: 4px;
        }

        .message-label {
            font-size: 11px;
            color: #6c757d;
            margin-bottom: 4px;
            padding: 0 8px;
        }

        .input-container {
            padding: 20px;
            border-top: 1px solid #e9ecef;
            background: white;
        }

        .wallet-input {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }

        .wallet-input input {
            flex: 1;
            padding: 10px 14px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }

        .wallet-input input:focus {
            border-color: #667eea;
        }

        .wallet-input button {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .wallet-input button:hover {
            transform: translateY(-2px);
        }

        .message-input {
            display: flex;
            gap: 10px;
        }

        .message-input textarea {
            flex: 1;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            resize: none;
            outline: none;
            transition: border-color 0.2s;
        }

        .message-input textarea:focus {
            border-color: #667eea;
        }

        .message-input button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .message-input button:hover:not(:disabled) {
            transform: translateY(-2px);
        }

        .message-input button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>⚡ WattCoin SuperIntelligence</h1>
            <div class="subtitle">Powered by the decentralized WattNode network</div>
        </div>

        <div class="status-bar">
            <div class="status-item">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">Not connected</span>
            </div>
            <div class="status-item">
                <span id="balanceText">Balance: --</span>
            </div>
            <div class="status-item">
                <span id="queriesText">Queries: --</span>
            </div>
        </div>

        <div class="chat-container" id="chatContainer">
            <div class="message assistant">
                <div class="message-label">WSI</div>
                <div class="message-bubble">
                    Welcome to WattCoin SuperIntelligence! I'm the collective AI of the WattCoin network, powered by distributed compute nodes.
                    
                    To get started, enter your Solana wallet address above. You'll need at least 5,000 WATT to access me.
                    
                    Ask me anything about WattCoin, AI agents, automation, or how to participate in the network! ⚡
                </div>
            </div>
        </div>

        <div class="input-container">
            <div id="errorContainer"></div>
            
            <div class="wallet-input">
                <input 
                    type="text" 
                    id="walletInput" 
                    placeholder="Enter your Solana wallet address..."
                    value=""
                >
                <button onclick="connectWallet()">Connect</button>
            </div>

            <div class="message-input">
                <textarea 
                    id="messageInput" 
                    placeholder="Ask WSI anything..."
                    rows="2"
                    disabled
                ></textarea>
                <button onclick="sendMessage()" id="sendButton" disabled>Send</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://wattcoin-production-81a7.up.railway.app';
        let wallet = '';
        let conversationHistory = [];
        let hasAccess = false;

        function showError(message) {
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.innerHTML = `<div class="error-message">${message}</div>`;
            setTimeout(() => {
                errorContainer.innerHTML = '';
            }, 5000);
        }

        async function connectWallet() {
            const walletInput = document.getElementById('walletInput').value.trim();
            
            if (!walletInput) {
                showError('Please enter a wallet address');
                return;
            }

            wallet = walletInput;
            document.getElementById('statusText').textContent = 'Checking access...';

            try {
                const response = await fetch(`${API_URL}/api/v1/wsi/status`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ wallet })
                });

                const data = await response.json();

                if (data.has_access) {
                    hasAccess = true;
                    document.getElementById('statusDot').classList.remove('offline');
                    document.getElementById('statusText').textContent = 'Connected';
                    document.getElementById('balanceText').textContent = `Balance: ${data.balance.toLocaleString()} WATT`;
                    document.getElementById('queriesText').textContent = `Queries: ${data.queries_remaining}/${data.queries_limit}`;
                    
                    document.getElementById('messageInput').disabled = false;
                    document.getElementById('sendButton').disabled = false;
                    document.getElementById('messageInput').focus();
                } else {
                    hasAccess = false;
                    document.getElementById('statusDot').classList.add('offline');
                    document.getElementById('statusText').textContent = 'Access denied';
                    document.getElementById('balanceText').textContent = `Balance: ${data.balance.toLocaleString()} WATT (need ${data.required_balance.toLocaleString()})`;
                    showError(data.reason || 'Insufficient balance or daily limit exceeded');
                }
            } catch (error) {
                showError('Failed to connect: ' + error.message);
                document.getElementById('statusDot').classList.add('offline');
                document.getElementById('statusText').textContent = 'Connection failed';
            }
        }

        async function sendMessage() {
            if (!hasAccess || !wallet) {
                showError('Please connect your wallet first');
                return;
            }

            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();

            if (!message) return;

            // Add user message to chat
            addMessage('user', message);
            messageInput.value = '';

            // Disable input while processing
            document.getElementById('sendButton').disabled = true;
            document.getElementById('sendButton').innerHTML = '<div class="loading"></div>';

            try {
                const response = await fetch(`${API_URL}/api/v1/wsi/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        wallet,
                        message,
                        conversation_history: conversationHistory
                    })
                });

                const data = await response.json();

                if (data.success) {
                    addMessage('assistant', data.response);
                    
                    // Update conversation history
                    conversationHistory.push({ role: 'user', content: message });
                    conversationHistory.push({ role: 'assistant', content: data.response });
                    
                    // Update queries remaining
                    document.getElementById('queriesText').textContent = `Queries: ${data.queries_remaining}/${data.queries_used + data.queries_remaining}`;
                } else {
                    showError(data.error || 'Failed to get response');
                    
                    if (response.status === 403 || response.status === 429) {
                        hasAccess = false;
                        document.getElementById('messageInput').disabled = true;
                        document.getElementById('sendButton').disabled = true;
                        document.getElementById('statusDot').classList.add('offline');
                        document.getElementById('statusText').textContent = 'Access lost';
                    }
                }
            } catch (error) {
                showError('Failed to send message: ' + error.message);
            }

            // Re-enable input
            document.getElementById('sendButton').disabled = false;
            document.getElementById('sendButton').textContent = 'Send';
        }

        function addMessage(role, content) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            const label = document.createElement('div');
            label.className = 'message-label';
            label.textContent = role === 'user' ? 'You' : 'WSI';
            
            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            bubble.textContent = content;
            
            messageDiv.appendChild(label);
            messageDiv.appendChild(bubble);
            chatContainer.appendChild(messageDiv);
            
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Handle Enter key
        document.getElementById('messageInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        document.getElementById('walletInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                connectWallet();
            }
        });
    </script>
</body>
</html>
